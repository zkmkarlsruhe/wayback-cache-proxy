{% extends "base.html" %}
{% block title %}Configuration{% endblock %}

{% block content %}
<h2>Configuration</h2>

{% if saved %}
<div class="flash flash-success">
  Configuration saved and reload signal sent to proxy.
</div>
{% endif %}

<form method="post" action="/config/">
  {% set sections = [
    ('proxy', 'Proxy Server', [
      ('host', 'text', 'Bind address'),
      ('port', 'number', 'Listen port'),
      ('error_pages_dir', 'text', 'Error pages directory'),
    ]),
    ('wayback', 'Wayback Machine', [
      ('target_date', 'text', 'Target date (YYYYMMDD)'),
      ('date_tolerance_days', 'number', 'Date tolerance (days)'),
      ('base_url', 'text', 'Wayback base URL'),
      ('geocities_fix', 'bool', 'GeoCities fix'),
    ]),
    ('cache', 'Cache', [
      ('redis_url', 'text', 'Redis URL'),
      ('hot_ttl_seconds', 'number', 'Hot cache TTL (seconds)'),
    ]),
    ('throttle', 'Throttle', [
      ('default_speed', 'text', 'Default speed'),
      ('allow_user_override', 'bool', 'Allow user override'),
    ]),
    ('header_bar', 'Header Bar', [
      ('enabled', 'bool', 'Enabled'),
      ('position', 'select:top,bottom', 'Position'),
      ('custom_text', 'text', 'Custom text'),
      ('show_speed_selector', 'bool', 'Show speed selector'),
    ]),
    ('landing_page', 'Landing Page', [
      ('enabled', 'bool', 'Enabled'),
      ('most_viewed_count', 'number', 'Most viewed count'),
    ]),
    ('admin', 'Admin', [
      ('enabled', 'bool', 'Enabled'),
      ('password', 'text', 'Password'),
    ]),
    ('access', 'Access Control', [
      ('mode', 'select:open,allowlist', 'Access mode'),
    ]),
    ('crawler', 'Crawler', [
      ('concurrency', 'number', 'Concurrency'),
      ('max_urls', 'number', 'Max URLs per crawl'),
    ]),
  ] %}

  {% for section_key, section_label, section_fields in sections %}
  <div class="config-section card">
    <h3>{{ section_label }}</h3>
    {% for field_key, field_type, field_label in section_fields %}
      {% set field_name = section_key + '.' + field_key %}
      {% set current = config.get(section_key, {}).get(field_key, '') %}
      <div class="config-field">
        <label for="{{ field_name }}">{{ field_label }}</label>
        {% if field_type == 'bool' %}
          <select name="{{ field_name }}" id="{{ field_name }}">
            <option value="true" {% if current %}selected{% endif %}>true</option>
            <option value="false" {% if not current %}selected{% endif %}>false</option>
          </select>
        {% elif field_type.startswith('select:') %}
          {% set options = field_type[7:].split(',') %}
          <select name="{{ field_name }}" id="{{ field_name }}">
            {% for opt in options %}
            <option value="{{ opt }}" {% if current == opt %}selected{% endif %}>{{ opt }}</option>
            {% endfor %}
          </select>
        {% elif field_type == 'number' %}
          <input type="number" name="{{ field_name }}" id="{{ field_name }}" value="{{ current }}">
        {% else %}
          <input type="text" name="{{ field_name }}" id="{{ field_name }}" value="{{ current }}">
        {% endif %}
      </div>
    {% endfor %}
  </div>
  {% endfor %}

  <button type="submit" class="btn btn-primary">Save & Reload</button>
</form>
{% endblock %}
